<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source: wp-accessibility-stats.php - WP Accessibility Hook Doumentation</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
    <link type="text/css" rel="stylesheet" href="styles-docs.css?v=0.1.2">
</head>

<body>

<div id="main">

    <header><h1 class="page-title">Source: wp-accessibility-stats.php</h1></header>
	<main>
    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>&lt;?php
/**
 * Track accessibility stats.
 *
 * @category Issues
 * @package  WP Accessibility
 * @author   Joe Dolson
 * @license  GPLv2 or later
 * @link     https://www.joedolson.com/wp-accessibility/
 */

/**
 * Define Stats collection post type.
 */
function wpa_post_type() {
	$labels = array(
		'name'               => 'WP Accessibility Stats Record',
		'singular_name'      => 'Stats',
		'menu_name'          => 'Accessibility Stats',
		'add_new'            => __( 'Add New', 'wp-accessibility' ),
		'add_new_item'       => __( 'Create New', 'wp-accessibility' ),
		'edit_item'          => __( 'Modify', 'wp-accessibility' ),
		'new_item'           => __( 'New', 'wp-accessibility' ),
		'view_item'          => __( 'View', 'wp-accessibility' ),
		'search_items'       => __( 'Search', 'wp-accessibility' ),
		'not_found'          => __( 'No stats found', 'wp-accessibility' ),
		'not_found_in_trash' => __( 'No stats found in trash', 'wp-accessibility' ),
		'parent_item_colon'  => '',
	);
	$args   = array(
		'labels'              => $labels,
		'public'              => false,
		'publicly_queryable'  => false,
		'exclude_from_search' => true,
		'show_ui'             => true,
		'show_in_menu'        => true,
		'menu_icon'           => 'dashicons-universal-access',
		'query_var'           => true,
		'hierarchical'        => false,
		'supports'            => array( 'title', 'editor', 'custom-fields' ),
	);
	register_post_type( 'wpa-stats', $args );
}
add_action( 'init', 'wpa_post_type' );

/**
 * Register taxonomies on WP Accessibility stats posts.
 */
function wpa_taxonomies() {
	register_taxonomy(
		'wpa-stats-type',
		// Internal name = machine-readable taxonomy name.
		array( 'wpa-stats' ),
		array(
			'hierarchical' => true,
			'label'        => __( 'WP Accessibility Statistic Type', 'wp-accessibility' ),
			'query_var'    => true,
			'rewrite'      => array( 'slug' => 'wpa-stats-type' ),
		)
	);
}
add_action( 'init', 'wpa_taxonomies', 0 );


/**
 * Register statistics.
 *
 * @param array      $stats Stats data for a page. Array of tests &amp; results.
 * @param string     $title Title for the stats record. Usually a relative URL.
 * @param string     $type Type of stat: view or action.
 * @param int|string $post_ID ID of the post if singular.
 */
function wpa_add_stats( $stats, $title, $type = 'view', $post_ID = 0 ) {
	$stats  = json_encode( $stats );
	$exists = wpa_get_post_by_title( $title );
	if ( $exists ) {
		if ( 'action' === $type ) {
			// Log all on/off states for toolbar.
			add_post_meta( $exists, 'wpa_event', $stats );
		} else {
			$old_stats = get_post( $exists )->post_content;
			if ( $stats !== $old_stats ) {
				// stats have changed; record the change.
				add_post_meta( $exists, 'wpa_event', $stats );
			}
		}
		return array( 'metadata logged' );
	} else {
		$post = array(
			'post_title'   => str_replace( home_url(), '', $title ),
			'post_content' => $stats,
			'post_status'  => 'publish',
			'post_name'    => sanitize_title( $title ),
			'post_date'    => current_time( 'Y-m-d H:i:s' ),
			'post_type'    => 'wpa-stats',
		);
		$stat = wp_insert_post( $post );
		wp_set_object_terms( $stat, array( $type ), 'wpa-stats-type' );
		if ( $post_ID ) {
			// Set up relationships between stats and posts.
			update_post_meta( $stat, '_wpa_post_id', $post_ID );
			update_post_meta( $post, '_wpa_stat_id', $stat );
		}
		return array( 'stats logged' );
	}
}

/**
 * Get stats post by title.
 *
 * @param mixed $title The title of a stats post.
 *
 * @return int
 */
function wpa_get_post_by_title( $title ) {
	global $wpdb;
	$post = $wpdb->get_var( $wpdb->prepare( "SELECT ID FROM $wpdb->posts WHERE post_title = %s AND post_type='wpa-stats'", $title ) );
	if ( $post ) {
		return $post;
	}

	return false;
}

/**
 * Attempts to correctly identify the current URL.
 *
 * @return string
 */
function wpa_get_current_url() {
	if ( is_admin() ) {
		return '';
	}
	global $wp, $wp_rewrite;
	$args = array();
	if ( isset( $_GET['page_id'] ) ) {
		$args = array( 'page_id' => absint( $_GET['page_id'] ) );
	}
	$current_url = home_url( add_query_arg( $args, $wp->request ) );

	if ( $wp_rewrite->using_index_permalinks() &amp;&amp; false === strpos( $current_url, 'index.php' ) ) {
		$current_url = str_replace( home_url(), home_url( '/' ) . 'index.php', $current_url );
	}

	if ( $wp_rewrite->using_permalinks() ) {
		$current_url = trailingslashit( $current_url );
	}
	/**
	 * Filter the URL returned for the current URL.
	 *
	 * @hook wpa_get_current_url
	 *
	 * @param {string} $current_url Current URL according to wp_rewrite.
	 *
	 * @return {string}
	 */
	$current_url = apply_filters( 'wpa_get_current_url', $current_url );

	return $current_url;
}

/**
 * Handle AJAX request to record stats.
 *
 * @return void
 */
function wpa_stats_action() {
	if ( isset( $_REQUEST['action'] ) &amp;&amp; 'wpa_stats_action' === $_REQUEST['action'] ) {
		$security = $_REQUEST['security'];
		if ( ! wp_verify_nonce( $security, 'wpa-stats-action' ) ) {
			wp_send_json( array( 'failed' => $_REQUEST ) );
		}
		$stats   = map_deep( $_REQUEST['stats'], 'sanitize_text_field' );
		$post_id = absint( $_REQUEST['post_id'] );
		$title   = ( wpa_is_url( $_REQUEST['title'] ) ) ? esc_url( $_REQUEST['title'] ) : sanitize_text_field( $_REQUEST['title'] );
		$type    = ( 'view' === $_REQUEST['type'] ) ? 'view' : 'event';
		// Add timestamp for this stat.
		$stats['timestamp'] = current_time( 'timestamp' ); // phpcs:ignore WordPress.DateTime.CurrentTimeTimestamp.Requested

		$response = wpa_add_stats( $stats, $title, $type, $post_id );
		wp_send_json( $response );
	} else {
		wp_send_json( array( 'no-request' => $_REQUEST ) );
	}
}
add_action( 'wp_ajax_wpa_stats_action', 'wpa_stats_action' );
add_action( 'wp_ajax_nopriv_wpa_stats_action', 'wpa_stats_action' );

/**
 * Register the WP Accessibility dashboard stats widget.
 *
 * @return void
 */
function wpa_dashboard_widget() {
	wp_add_dashboard_widget( 'wpa_dashboard_widget_stats', __( 'WP Accessibility Stats', 'wp-accessibility' ), 'wpa_dashboard_widget_stats_handler' );
}
add_action( 'wp_dashboard_setup', 'wpa_dashboard_widget' );

/**
 * Output the WP Accessibility stats widget.
 *
 * @return void
 */
function wpa_dashboard_widget_stats_handler() {
	echo '&lt;p>' . __( 'WP Accessibility is tracking accessibility changes it makes to your site, and recording when vistors toggle the font size and high contrast options. No personally identifying data is stored.', 'wp-accessibility' ) . '&lt;/p>';
	wpa_get_stats( 'view' );
	wpa_get_stats( 'event' );
}

/**
 * Get stats data for WP Accessibility.
 *
 * @param string $type Type of stats to fetch. 'view' or 'event'.
 *
 * @return void
 */
function wpa_get_stats( $type = 'view', $count = 3 ) {
	$query = array(
		'post_type'  => 'wpa-stats',
		'numberpost' => $count,
		'orderby'    => 'date',
		'order'      => 'desc',
		'tax_query'  => array(
			array(
				'taxonomy' => 'wpa-stats-type',
				'field'    => 'slug',
				'terms'    => $type,
			),
		),
	);

	$posts = new WP_Query( $query );
	if ( 'view' === $type ) {
		echo '&lt;div class="activity-block">&lt;h3>' . __( 'Accessibility Fixes', 'wp-accessibility' ) . '&lt;/h3>&lt;ul>';
	} else {
		echo '&lt;div class="activity-block">&lt;h3>' . __( 'User Actions', 'wp-accessibility' ) . '&lt;/h3>&lt;ul>';
	}

	foreach ( $posts->posts as $post ) {
		$post_ID  = $post->ID;
		$data     = json_decode( $post->post_content );
		$history  = get_post_meta( $post_ID, 'wpa_event' );
		$relative = get_post_meta( $post_ID, '_wpa_post_id', true );
		echo '&lt;li>&lt;div class="wpa-header">&lt;h3>&lt;strong>' . gmdate( get_option( 'date_format' ), $data->timestamp ) . '&lt;/strong>&lt;br />' . gmdate( get_option( 'time_format' ), $data->timestamp ) . '&lt;/h3>';

		$post_title = ( $relative ) ? get_the_title( $relative ) : 'User action';
		$post_link  = ( $relative ) ? get_the_permalink( $relative ) : '';
		$append     = '';
		if ( 'event' === $type ) {
			// translators: Post ID.
			$append = ' / ' . sprintf( __( 'User %s', 'wp-accessibility' ), '&lt;code>' . $post->ID . '&lt;/code>' );
		}
		if ( $post_link ) {
			echo '&lt;p>&lt;a href="' . esc_url( $post_link ) . '">' . $post_title . '&lt;/a>' . $append . '&lt;/p>';
		} else {
			echo '&lt;p>&lt;strong>' . $post_title . '&lt;/strong>' . $append . '&lt;/p>';		
		}
		echo '&lt;/div>';

		$line = '';
		if ( 'event' === $type ) {
			// translators: change made, date changed, time changed.
			$hc_text = __( 'High contrast %1$s on %2$s at %3$s', 'wp-accessibility' );
			// translators: change made, date changed, time changed.
			$lf_text = __( 'Large font size %1$s on %2$s at %3$s', 'wp-accessibility' );
			$first = ( property_exists( $data, 'contrast' ) ) ? $hc_text : $lf_text;
			$param = ( property_exists( $data, 'contrast' ) ) ? 'contrast' : 'fontsize';
			$date  = gmdate( 'Y-m-d', $data->timestamp );
			$time  = gmdate( 'H:i', $data->timestamp );
			$line = '&lt;li>' . sprintf( $first, $data->{$param}, $date, $time ) . '&lt;/li>';
			foreach ( $history as $h ) {
				$h             = json_decode( $h );
				$has_font_size = ( property_exists( $h, 'fontsize' ) ) ? $h->fontsize : false;
				$has_contrast  = ( property_exists( $h, 'contrast' ) ) ? $h->contrast : false;
				$change_date   = gmdate( 'Y-m-d', $h->timestamp );
				$change_time   = gmdate( 'H:i', $h->timestamp );
				if ( $has_font_size ) {
					$line .= '&lt;li>' . sprintf( $lf_text, $has_font_size, $change_date, $change_time ) . '&lt;/li>';
				} elseif ( $has_contrast ) {
					$line .= '&lt;li>' . sprintf( $hc_text, $has_contrast, $change_date, $change_time ) . '&lt;/li>';
				}
			}
		} else {
			foreach ( $data as $d ) {
				if ( is_array( $d ) ) {
					$key   = wpa_map_key( $d[0] );
					$count = $d[1];
					$stat = "&lt;span class='wpa-item-count'>$count&lt;/span> " . $key;
				} else {
					// If this is the timestamp, don't display here.
					if ( is_numeric( $d ) ) {
						continue;
					}
					$stat = wpa_map_key( $d );
				}
				$line .= '&lt;li>' . $stat . '&lt;/li>';
			}
		}

		echo '&lt;ul class="stats">' . $line . '&lt;/ul>&lt;/li>';
	}
	echo '&lt;/ul>&lt;/div>';
}

/**
 * Map an array key to a text string.
 *
 * @param string $key Stats array key.
 *
 * @return string
 */
function wpa_map_key( $key ) {
	$strings = array(
		'link-add-tabindex'   => __( '&lt;code>tabindex&lt;/code> was removed from a link.', 'wp-accessibility' ),
		'button-add-tabindex' => __( '&lt;code>tabindex&lt;/code> was added to a fake button.', 'wp-accessibility' ),
		'control-tabindex'    => __( '&lt;code>tabindex&lt;/code> were removed from links, inputs, and buttons.', 'wp-accessibility' ),
		'link-targets'        => __( '&lt;code>target&lt;/code> attributes were removed from links.', 'wp-accessibility' ),
		'input-titles'        => __( '&lt;code>title&lt;/code> attributes were removed from inputs.', 'wp-accessibility' ),
		'control-titles'      => __( '&lt;code>title&lt;/code> attributes removed from inputs and buttons.', 'wp-accessibility' ),
		'images-titles'       => __( '&lt;code>title&lt;/code> attributes removed from images.', 'wp-accessibility' ),
		'implicit-label'      => __( 'Implicit &lt;code>label&lt;/code> elements added to inputs.', 'wp-accessibility' ),
		'explicit-label'      => __( 'Explicit &lt;code>label&lt;/code> elements added to inputs.', 'wp-accessibility' ),
		'aria-current'        => __( '&lt;code>aria-current&lt;/code> was assigned to a link.', 'wp-accessibility' ),
		'skiplinks'           => __( 'Skiplinks added to the page.', 'wp-accessibility' ),
		'viewport-maxscale'   => __( 'The viewport maximum scale was fixed.', 'wp-accessibility' ),
		'viewport-scalable'   => __( 'The scalability of the viewport was fixed.', 'wp-accessibility' ),
		'html-lang-direction' => __( 'The language direction was set.', 'wp-accessibility' ),
		'html-lang'           => __( 'The language of the page was set.', 'wp-accessibility' ),
	);
	$string = ( isset( $strings[ $key ] ) ) ? $strings[ $key ] : $key;

	return $string;
}

/**
 * Format stats for brief display.
 *
 * @param string $type Type of stat to display.
 * @param array  $data Array of saved data.
 * @param array  $history History for this stat.
 *
 * @return string
 */
function wpa_format_stats( $type, $data, $history ) {
	if ( 'toolbar' === $type ) {
		$history = (array) $history;
		foreach ( $history as $k => $d ) {
			return '&lt;strong>' . $k . '&lt;/strong>:' . print_r( $d, 1 );
		}
	} else {
		$data = (array) $data;
		$i    = 0;
		foreach ( $data as $k => $d ) {
			$i++;
		}
		return $i;
	}
	return '';
}
</code></pre>
        </article>
    </section>




	</main>
    <footer>
		<a href="https://make.wordpress.org/accessibility/handbook/which-tools-can-i-use/wp-accessibility-plugin/">WP Accessibility User Documentation</a> &bull;
		<a href="https://github.com/joedolson/wp-accessibility/">WP Accessibility on GitHub</a> &bull;
	</footer>

	
</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Filters</h3><ul><li><a href="asl_extra_target.html">asl_extra_target</a></li><li><a href="asl_sitemap.html">asl_sitemap</a></li><li><a href="wpa_case_insensitive.html">wpa_case_insensitive</a></li><li><a href="wpa_case_sensitive.html">wpa_case_sensitive</a></li><li><a href="wpa_disable_labels.html">wpa_disable_labels</a></li><li><a href="wpa_fontsize_css.html">wpa_fontsize_css</a></li><li><a href="wpa_get_current_url.html">wpa_get_current_url</a></li><li><a href="wpa_labels.html">wpa_labels</a></li><li><a href="wpa_long_alt.html">wpa_long_alt</a></li><li><a href="wpa_move_toolbar.html">wpa_move_toolbar</a></li><li><a href="wpa_remove_titles.html">wpa_remove_titles</a></li><li><a href="wpa_show_alt_selector.html">wpa_show_alt_selector</a></li><li><a href="wpa_skiplink_styles.html">wpa_skiplink_styles</a></li><li><a href="wpa_summary_heading.html">wpa_summary_heading</a></li><li><a href="wpa_summary_heading_level.html">wpa_summary_heading_level</a></li><li><a href="wpa_toolbar_css.html">wpa_toolbar_css</a></li><li><a href="wpa_underline_target.html">wpa_underline_target</a></li><li><a href="wpa_view_remediation_logs.html">wpa_view_remediation_logs</a></li></ul><h3>Tutorials</h3><ul><li><a href="tutorial-change-accessibility-toolbar-attachment-element.html">change-accessibility-toolbar-attachment-element</a></li><li><a href="tutorial-custom-fontsize-stylesheet.html">custom-fontsize-stylesheet</a></li></ul>
</nav>

<br class="clear">

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
